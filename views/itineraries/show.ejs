<section class="py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h5 mb-0"><%= it.title %></h1>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="/dashboard/itineraries">Back</a>
      <a class="btn btn-sm btn-outline-primary" href="/dashboard/itineraries/<%= it._id %>/edit"><i class="fa-solid fa-pen me-1"></i> Edit</a>
      <a class="btn btn-sm btn-primary" href="/dashboard/itineraries/<%= it._id %>/print" target="_blank" rel="noopener"><i class="fa-solid fa-print me-1"></i> Open Print Preview</a>
      <form action="/dashboard/itineraries/<%= it._id %>/delete" method="post" class="d-inline" onsubmit="return confirm('Delete this itinerary? This action cannot be undone.');">
        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fa-solid fa-trash me-1"></i> Delete</button>
      </form>
    </div>
  </div>
  <div class="mb-2 text-muted small">
    <span class="me-3">Start: <%= it.startDate ? new Date(it.startDate).toLocaleDateString('en-GB') : '-' %></span>
    <span class="me-3">Pax: Adults <%= it.pax?.adults || 0 %>, Children <%= it.pax?.children || 0 %></span>
    <% if (it.clientName) { %><span class="me-3">Client: <%= it.clientName %></span><% } %>
    <span>Total: USD <%= Number(it.totals?.grand || 0).toLocaleString('en-US') %></span>
  </div>
  <div class="card sb-card"><div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead><tr><th>Day</th><th>Route</th><th>Accommodation</th><th class="text-end">Est. Total (USD)</th></tr></thead>
        <tbody>
          <% let dayTotal = 0; %>
          <% (it.days || []).forEach(function(d, idx){ %>
            <% const r = d.route || {}; 
               const adults = Number(it.pax?.adults||0), children = Number(it.pax?.children||0);
               const v = Number(r.vehicle_fee||0), t = Number(r.transit_fee||0);
               const parkAdultUnit = Number(r.park_fee_adult||0), parkChildUnit = Number(r.park_fee_child||0);
               const pa = parkAdultUnit * adults;
               const pc = parkChildUnit * children;
               const p = (typeof r.park_fee_adult !== 'undefined' || typeof r.park_fee_child !== 'undefined') ? (pa+pc) : Number(r.park_fee||0);
               const adultUnit = Number(d.accomodation?.adult_price ?? 0);
               const childUnit = Number(d.accomodation?.child_price ?? 0);
               const acc = (adultUnit * adults) + (childUnit * children);
               dayTotal = v+p+t+acc; %>
            <tr>
              <td><%= idx+1 %></td>
              <td>
                <div class="fw-semibold"><%= r?.name || '-' %></div>
                <div class="small text-muted"><%= r?.origin || '-' %> → <%= r?.destination || '-' %></div>
                <div class="small text-muted mt-1">
                  Vehicle: USD <%= v.toLocaleString('en-US') %><br>
                  Park: USD <%= p.toLocaleString('en-US') %>
                  <% if (parkAdultUnit || parkChildUnit) { %>
                    <span class="text-muted">(Adults <%= parkAdultUnit %> × <%= adults %>, Children <%= parkChildUnit %> × <%= children %>)</span>
                  <% } %>
                  <% if (t) { %><br>Transit: USD <%= t.toLocaleString('en-US') %><% } %>
                </div>
              </td>
              <td>
                <div><%= d.accomodation?.name || 'N/A' %></div>
                <div class="small text-muted">
                  Unit (Adult): USD <%= adultUnit.toLocaleString('en-US') %> | Unit (Child): USD <%= childUnit.toLocaleString('en-US') %><br>
                  <span class="d-block">Subtotal: USD <%= acc.toLocaleString('en-US') %></span>
                </div>
              </td>
              <td class="text-end">USD <%= Number(dayTotal).toLocaleString('en-US') %></td>
            </tr>
          <% }) %>
          <tr class="fw-semibold">
            <td colspan="3" class="text-end">Accommodation</td>
            <td class="text-end">USD <%= Number(it.totals?.accomodation||0).toLocaleString('en-US') %></td>
          </tr>
          <tr class="fw-semibold">
            <td colspan="3" class="text-end">Vehicle</td>
            <td class="text-end">USD <%= Number(it.totals?.vehicle||0).toLocaleString('en-US') %></td>
          </tr>
          <tr class="fw-semibold">
            <td colspan="3" class="text-end">Park</td>
            <td class="text-end">USD <%= Number(it.totals?.park||0).toLocaleString('en-US') %></td>
          </tr>
          <tr class="fw-semibold">
            <td colspan="3" class="text-end">Transit</td>
            <td class="text-end">USD <%= Number(it.totals?.transit||0).toLocaleString('en-US') %></td>
          </tr>
          <tr class="fw-bold">
            <td colspan="3" class="text-end">Grand Total</td>
            <td class="text-end">USD <%= Number(it.totals?.grand||0).toLocaleString('en-US') %></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div></div>
</section>
