<section class="py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h5 mb-0">Edit Itinerary</h1>
      <p class="text-muted small mb-0">Update the basic info and day-by-day plan.</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="/dashboard/itineraries/<%= it._id %>">Cancel</a>
      <a class="btn btn-sm btn-outline-secondary" href="/dashboard/itineraries">All Itineraries</a>
    </div>
  </div>

  <% if (missingRoutesCount > 0) { %>
    <div class="alert alert-warning" role="alert">
      <strong><%= missingRoutesCount %></strong> day(s) reference routes that no longer exist. Please select an available route for each affected day before saving.
    </div>
  <% } %>

  <form id="it-edit-form" action="/dashboard/itineraries/<%= it._id %>/edit" method="post" class="sb-form">
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label" for="title">Title</label>
        <input id="title" name="title" class="form-control" value="<%= it.title %>" required>
      </div>
      <div class="col-md-4">
        <label class="form-label" for="clientName">Client Name</label>
        <input id="clientName" name="clientName" class="form-control" value="<%= it.clientName || '' %>">
      </div>
      <div class="col-md-3">
        <label class="form-label" for="startDate">Start Date</label>
        <input id="startDate" name="startDate" type="date" class="form-control" value="<%= it.startDate ? new Date(it.startDate).toISOString().slice(0,10) : '' %>">
      </div>
      <div class="col-md-2">
        <label class="form-label" for="adults">Adults</label>
        <input id="adults" name="adults" type="number" class="form-control" value="<%= it.pax?.adults || 0 %>" min="0">
      </div>
      <div class="col-md-2">
        <label class="form-label" for="children">Children</label>
        <input id="children" name="children" type="number" class="form-control" value="<%= it.pax?.children || 0 %>" min="0">
      </div>
    </div>

    <div class="card sb-card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 mb-0">Days</h2>
          <button id="add-day-btn" class="btn btn-sm btn-outline-primary" type="button"><i class="fa-solid fa-plus me-1"></i> Add Day</button>
        </div>
        <div id="days-list" class="d-flex flex-column gap-2">
          <% (formDays || []).forEach(function(day, idx){ %>
            <div class="row g-2 align-items-end it-day-row" data-row="<%= idx + 1 %>">
              <div class="col-6 col-md-2 col-lg-1">
                <label class="form-label" for="day-<%= idx + 1 %>">Day</label>
                <input id="day-<%= idx + 1 %>" name="day" type="number" class="form-control form-control-sm" value="<%= day.dayValue %>" min="1">
              </div>
              <div class="col-12 col-md-5 col-lg-4">
                <label class="form-label" for="routeId-<%= idx + 1 %>">Route</label>
                <select id="routeId-<%= idx + 1 %>" name="routeId" class="form-select form-select-sm" required>
                  <option value="">Select route</option>
                  <% (routes || []).forEach(function(r){ const selected = day.routeId === String(r._id); %>
                    <option value="<%= r._id %>" <%= selected ? 'selected' : '' %>><%= r.name %></option>
                  <% }) %>
                </select>
              </div>
              <div class="col-12 col-md-5 col-lg-3">
                <label class="form-label" for="accomodationId-<%= idx + 1 %>">Accommodation</label>
                <select id="accomodationId-<%= idx + 1 %>" name="accomodationId" class="form-select form-select-sm">
                  <option value="">Optional — choose accommodation</option>
                  <% (accomodations || []).forEach(function(a){ const selected = day.accomodationId === String(a._id); %>
                    <option value="<%= a._id %>" <%= selected ? 'selected' : '' %>><%= a.accomodation_name %> — <%= a.place %> <%= a.isLuxury ? '(Luxury)' : '' %></option>
                  <% }) %>
                </select>
                <% if (day.accomodationMissing) { %>
                  <div class="form-text text-danger">Previously: <%= day.accomodationName %> (no longer available)</div>
                <% } %>
              </div>
              <div class="col-6 col-md-2 col-lg-2">
                <label class="form-label" for="adult_price-<%= idx + 1 %>">Adult USD</label>
                <input id="adult_price-<%= idx + 1 %>" name="adult_price" type="number" class="form-control form-control-sm" value="<%= day.adult_price %>" min="0" step="1">
              </div>
              <div class="col-6 col-md-2 col-lg-1">
                <label class="form-label" for="child_price-<%= idx + 1 %>">Child USD</label>
                <input id="child_price-<%= idx + 1 %>" name="child_price" type="number" class="form-control form-control-sm" value="<%= day.child_price %>" min="0" step="1">
              </div>
              <div class="col-12 col-md-1 col-lg-1 text-md-end text-lg-end">
                <button type="button" class="btn btn-outline-danger btn-sm mt-2 mt-md-0" data-remove-row><i class="fa-solid fa-trash"></i></button>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-6">
        <label class="form-label" for="inclusionsText">Price Inclusions (one per line)</label>
        <textarea id="inclusionsText" name="inclusionsText" class="form-control" rows="5"><%= inclusionsText || '' %></textarea>
        <div class="form-text">Shown on the client PDF.</div>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="exclusionsText">Price Exclusions (one per line)</label>
        <textarea id="exclusionsText" name="exclusionsText" class="form-control" rows="5"><%= exclusionsText || '' %></textarea>
        <div class="form-text">Defaults apply when left blank.</div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-3">
        <label class="form-label" for="profitPercent">Company Profit (%)</label>
        <input id="profitPercent" name="profitPercent" type="number" class="form-control" value="<%= profitPercent %>" min="0" max="100" step="0.1">
        <div class="form-text">Internal only; never printed.</div>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-3">
      <a class="btn btn-outline-secondary" href="/dashboard/itineraries/<%= it._id %>">Cancel</a>
      <button class="btn btn-primary" type="submit">Save Changes</button>
    </div>
  </form>
</section>

<script>
  (function(){
    var addBtn = document.getElementById('add-day-btn');
    var list = document.getElementById('days-list');
    function addRow(){
      var count = list.querySelectorAll('.it-day-row').length + 1;
      var template = list.querySelector('.it-day-row');
      if (!template) return;
      var clone = template.cloneNode(true);
      clone.setAttribute('data-row', String(count));
      var dayInput = clone.querySelector('[name="day"]');
      if (dayInput) {
        dayInput.value = count;
        dayInput.id = 'day-' + count;
        var dayLabel = clone.querySelector('label[for^="day-"]');
        if (dayLabel) dayLabel.setAttribute('for', 'day-' + count);
      }
      var routeSelect = clone.querySelector('[name="routeId"]');
      if (routeSelect) {
        routeSelect.value = '';
        routeSelect.id = 'routeId-' + count;
        var routeLabel = clone.querySelector('label[for^="routeId-"]');
        if (routeLabel) routeLabel.setAttribute('for', 'routeId-' + count);
      }
      var accSelect = clone.querySelector('[name="accomodationId"]');
      if (accSelect) {
        accSelect.value = '';
        accSelect.id = 'accomodationId-' + count;
        var accLabel = clone.querySelector('label[for^="accomodationId-"]');
        if (accLabel) accLabel.setAttribute('for', 'accomodationId-' + count);
      }
      var aInput = clone.querySelector('[name="adult_price"]');
      if (aInput) {
        aInput.value = '0';
        aInput.id = 'adult_price-' + count;
        var aLabel = clone.querySelector('label[for^="adult_price-"]');
        if (aLabel) aLabel.setAttribute('for', 'adult_price-' + count);
      }
      var cInput = clone.querySelector('[name="child_price"]');
      if (cInput) {
        cInput.value = '0';
        cInput.id = 'child_price-' + count;
        var cLabel = clone.querySelector('label[for^="child_price-"]');
        if (cLabel) cLabel.setAttribute('for', 'child_price-' + count);
      }
      var warnings = clone.querySelectorAll('.text-danger');
      warnings.forEach(function(el){ el.remove(); });
      list.appendChild(clone);
    }
    addBtn && addBtn.addEventListener('click', addRow);
    list && list.addEventListener('click', function(e){
      var btn = e.target.closest('[data-remove-row]');
      if (!btn) return;
      var rows = list.querySelectorAll('.it-day-row');
      var row = btn.closest('.it-day-row');
      if (!row) return;
      if (rows.length > 1) {
        row.remove();
      } else {
        var dayInput = row.querySelector('[name="day"]');
        if (dayInput) dayInput.value = '1';
        var routeSelect = row.querySelector('[name="routeId"]');
        if (routeSelect) routeSelect.value = '';
        var acc = row.querySelector('[name="accomodationId"]');
        if (acc) acc.value = '';
        var aInput = row.querySelector('[name="adult_price"]');
        if (aInput) aInput.value = '0';
        var cInput = row.querySelector('[name="child_price"]');
        if (cInput) cInput.value = '0';
      }
    });
  })();
</script>
