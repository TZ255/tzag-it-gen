<section class="py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h5 mb-0">New Itinerary • Review</h1>
    <a class="btn btn-sm btn-outline-secondary" href="/dashboard/itineraries/new">Back</a>
  </div>
  <div class="mb-2 text-muted small">
    <% const baseGrand = Number(totals?.grand || 0); const finalGrand = Number((totalsWithProfit && totalsWithProfit.grandWithProfit) || baseGrand); %>
    <span class="me-3">Start: <%= startDateDraft ? new Date(startDateDraft).toLocaleDateString('en-GB') : '-' %></span>
    <span class="me-3">Pax: Adults <%= pax.adults %>, Children <%= pax.children %></span>
    <span class="me-3">Base Total: USD <%= baseGrand.toLocaleString('en-US') %></span>
    <span class="me-3">Profit: <%= Number(profitPercent || 0).toFixed(2) %>% (USD <%= Number(profitAmount || 0).toLocaleString('en-US') %>)</span>
    <span>Client Total: USD <%= finalGrand.toLocaleString('en-US') %></span>
  </div>
  <div class="card sb-card"><div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead><tr><th>#</th><th>Day</th><th>Route</th><th>Accommodation</th><th class="text-end">Est. Total (USD)</th></tr></thead>
        <tbody>
          <% (days || []).forEach(function(d){
               const fees = d.fees || {};
               const route = d.route || {};
               const parkAdult = Number(fees.parkAdults || 0);
               const parkChild = Number(fees.parkChildren || 0);
               const dayTotal = Number(fees.vehicle||0) + Number(fees.parkTotal||0) + Number(fees.transit||0) + Number(fees.accomodation||0);
          %>
            <tr>
              <td><%= d.index %></td>
              <td><%= d.day %></td>
              <td>
                <div class="fw-semibold"><%= route.name || '-' %></div>
                <div class="small text-muted"><%= route.origin || '-' %> → <%= route.destination || '-' %></div>
                <div class="small text-muted mt-1">
                  Vehicle: USD <%= Number(fees.vehicle||0).toLocaleString('en-US') %><br>
                  Park: USD <%= Number(fees.parkTotal||0).toLocaleString('en-US') %>
                  <% if (parkAdult || parkChild) { %>
                    <span class="text-muted">(Adults <%= parkAdult %>, Children <%= parkChild %>)</span>
                  <% } %><br>
                  <% if (fees.transit) { %>
                    Transit: USD <%= Number(fees.transit).toLocaleString('en-US') %>
                  <% } %>
                </div>
              </td>
              <td>
                <div><%= d.accomodationName || 'N/A' %></div>
                <div class="small text-muted">
                  Unit (Adult): USD <%= Number(fees.adultUnit||0).toLocaleString('en-US') %>
                  <span class="d-block">Unit (Child): USD <%= Number(fees.childUnit||0).toLocaleString('en-US') %></span>
                  <span class="d-block fw-semibold">Subtotal: USD <%= Number(fees.accomodation||0).toLocaleString('en-US') %></span>
                </div>
              </td>
              <td class="text-end">USD <%= Number(dayTotal).toLocaleString('en-US') %></td>
            </tr>
          <% }) %>
          <tr class="fw-semibold"><td colspan="4" class="text-end">Accommodation</td><td class="text-end">USD <%= Number(totals?.accomodation||0).toLocaleString('en-US') %></td></tr>
          <tr class="fw-semibold"><td colspan="4" class="text-end">Vehicle</td><td class="text-end">USD <%= Number(totals?.vehicle||0).toLocaleString('en-US') %></td></tr>
          <tr class="fw-semibold"><td colspan="4" class="text-end">Park</td><td class="text-end">USD <%= Number(totals?.park||0).toLocaleString('en-US') %></td></tr>
          <tr class="fw-semibold"><td colspan="4" class="text-end">Transit</td><td class="text-end">USD <%= Number(totals?.transit||0).toLocaleString('en-US') %></td></tr>
          <tr class="fw-semibold"><td colspan="4" class="text-end">Company Profit (<%= Number(profitPercent||0).toFixed(2) %>%)</td><td class="text-end">USD <%= Number(profitAmount||0).toLocaleString('en-US') %></td></tr>
          <tr class="fw-bold"><td colspan="4" class="text-end">Client Grand Total</td><td class="text-end">USD <%= Number((totalsWithProfit && totalsWithProfit.grandWithProfit) || totals?.grand || 0).toLocaleString('en-US') %></td></tr>
        </tbody>
      </table>
    </div>
  </div></div>

  <div class="row g-3 mt-3">
    <div class="col-md-6">
      <div class="card sb-card"><div class="card-body">
        <h2 class="h6">Inclusions</h2>
        <% if ((inclusionsList || []).length === 0) { %>
          <p class="text-muted small mb-0">No custom inclusions provided. Defaults will be used.</p>
        <% } else { %>
          <ul class="mb-0">
            <% inclusionsList.forEach(function(item){ %>
              <li><%= item %></li>
            <% }) %>
          </ul>
        <% } %>
      </div></div>
    </div>
    <div class="col-md-6">
      <div class="card sb-card"><div class="card-body">
        <h2 class="h6">Exclusions</h2>
        <% if ((exclusionsList || []).length === 0) { %>
          <p class="text-muted small mb-0">No custom exclusions provided. Defaults will be used.</p>
        <% } else { %>
          <ul class="mb-0">
            <% exclusionsList.forEach(function(item){ %>
              <li><%= item %></li>
            <% }) %>
          </ul>
        <% } %>
      </div></div>
    </div>
  </div>

  <form id="review-create-form" action="/dashboard/itineraries" method="post" class="mt-3">
    <input type="hidden" name="title" value="<%= titleDraft %>">
    <input type="hidden" name="clientName" value="<%= clientNameDraft || '' %>">
    <input type="hidden" name="startDate" value="<%= startDateDraft %>">
    <input type="hidden" name="adults" value="<%= pax.adults %>">
    <input type="hidden" name="children" value="<%= pax.children %>">
    <% (days || []).forEach(function(d){ %>
      <input type="hidden" name="routeId" value="<%= d.route._id %>">
      <input type="hidden" name="accomodationId" value="<%= d.accomodationId || '' %>">
      <input type="hidden" name="adult_price" value="<%= Number(d.fees.adultUnit || 0) %>">
      <input type="hidden" name="child_price" value="<%= Number(d.fees.childUnit || 0) %>">
    <% }) %>
    <textarea name="inclusionsText" class="d-none"><%= inclusionsText || '' %></textarea>
    <textarea name="exclusionsText" class="d-none"><%= exclusionsText || '' %></textarea>
    <input type="hidden" name="profitPercent" value="<%= Number(profitPercent || 0) %>">
    <div class="d-flex justify-content-end gap-2">
      <a class="btn btn-outline-secondary" href="/dashboard/itineraries/new">Back</a>
      <button id="review-create-btn" class="btn btn-primary" type="submit">
        <span class="label">Create Itinerary</span>
        <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
      </button>
    </div>
  </form>
</section>

<script>
  (function () {
    const form = document.getElementById('review-create-form');
    const btn = document.getElementById('review-create-btn');
    if (!form || !btn) return;
    form.addEventListener('submit', function () {
      btn.disabled = true;
      btn.classList.add('disabled');
      const spinner = btn.querySelector('.spinner-border');
      if (spinner) spinner.classList.remove('d-none');
      const label = btn.querySelector('.label');
      if (label) label.textContent = 'Creating...';
    });
  }());
</script>
