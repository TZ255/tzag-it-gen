<section class="py-4">
  <h1 class="h5 mb-3">New Itinerary • Step 1</h1>
  <form id="it-new-form" action="/dashboard/itineraries/new/choose-acc" method="post" class="sb-form">
    <div class="row g-3 mb-3">
      <div class="col-md-4"><label class="form-label" for="title">Title</label><input id="title" name="title" class="form-control" placeholder="e.g., 7-Day Northern Circuit" required></div>
      <div class="col-md-4"><label class="form-label" for="clientName">Client Name</label><input id="clientName" name="clientName" class="form-control" placeholder="Client full name"></div>
      <div class="col-md-3"><label class="form-label" for="startDate">Start Date</label><input id="startDate" name="startDate" type="date" class="form-control"></div>
      <div class="col-md-2"><label class="form-label" for="adults">Adults</label><input id="adults" name="adults" type="number" class="form-control" value="2" min="0"></div>
      <div class="col-md-2"><label class="form-label" for="children">Children</label><input id="children" name="children" type="number" class="form-control" value="0" min="0"></div>
    </div>

    <div class="card sb-card"><div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="h6 mb-0">Days</h2>
        <button id="add-day-btn" class="btn btn-sm btn-outline-primary" type="button"><i class="fa-solid fa-plus me-1"></i> Add Day</button>
      </div>
      <div id="days-list" class="d-flex flex-column gap-2">
        <div class="row g-2 align-items-end it-day-row" data-row="1">
      <div class="col-6 col-md-2 col-lg-1">
        <label class="form-label" for="day-1">Day</label>
        <input id="day-1" name="day" type="number" class="form-control form-control-sm" value="1" min="1">
      </div>
      <div class="col-12 col-md-5 col-lg-4 position-relative">
        <label class="form-label" for="route-search-1">Route</label>
        <input id="route-search-1" type="text" class="form-control form-control-sm search-input" data-kind="route" placeholder="Search route" autocomplete="off" required>
        <input type="hidden" name="routeId" value="">
        <div class="search-popover list-group d-none"></div>
      </div>
      <div class="col-12 col-md-5 col-lg-3 position-relative">
        <label class="form-label" for="accommodation-search-1">Accommodation</label>
        <input id="accommodation-search-1" type="text" class="form-control form-control-sm search-input" data-kind="accommodation" placeholder="Search accommodation (optional)" autocomplete="off">
        <input type="hidden" name="accomodationId" value="">
        <div class="search-popover list-group d-none"></div>
      </div>
      <div class="col-6 col-md-2 col-lg-2">
        <label class="form-label" for="adult_price-1">Adult USD</label>
        <input id="adult_price-1" name="adult_price" type="number" class="form-control form-control-sm" value="0" min="0" step="1">
      </div>
          <div class="col-6 col-md-2 col-lg-1">
            <label class="form-label" for="child_price-1">Child USD</label>
            <input id="child_price-1" name="child_price" type="number" class="form-control form-control-sm" value="0" min="0" step="1">
          </div>
          <div class="col-12 col-md-1 col-lg-1 text-md-end text-lg-end">
            <button type="button" class="btn btn-outline-danger btn-sm mt-2 mt-md-0" data-remove-row><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>
      </div>
    </div></div>

    <div class="row g-3 mt-3">
      <div class="col-md-6">
        <label class="form-label" for="inclusionsText">Price Inclusions (one per line)</label>
        <textarea id="inclusionsText" name="inclusionsText" class="form-control" rows="5" placeholder="Private 4x4 vehicle\nProfessional guide\nAll park fees"></textarea>
        <div class="form-text">Use a new line for each item. These appear on the final PDF.</div>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="exclusionsText">Price Exclusions (one per line)</label>
        <textarea id="exclusionsText" name="exclusionsText" class="form-control" rows="5" placeholder="International flights\nVisa fees\nPersonal insurance"></textarea>
        <div class="form-text">Leave blank if you want to rely on the default language.</div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-3">
        <label class="form-label" for="profitPercent">Company Profit (%)</label>
        <input id="profitPercent" name="profitPercent" type="number" class="form-control" value="0" min="0" max="100" step="0.1">
        <div class="form-text">Internal only. Not shown on the client PDF.</div>
      </div>
    </div>

    <div class="d-flex justify-content-end mt-3"><button class="btn btn-primary" type="submit">Next</button></div>
  </form>
</section>

<style>
  .search-popover {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 20;
    max-height: 220px;
    overflow-y: auto;
    border: 1px solid var(--bs-border-color, #dee2e6);
    border-radius: 0.5rem;
    background: #fff;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }
  .search-popover .list-group-item { cursor: pointer; }
  .search-popover .list-group-item small { color: #6c757d; }
</style>

<script>
    (function(){
      var addBtn = document.getElementById('add-day-btn');
      var list = document.getElementById('days-list');
      var routesData = <%- JSON.stringify(routes || []) %>;
      var accData = <%- JSON.stringify(accomodations || []) %>;

      function formatRoutes(data) {
        return (data || []).map(function(r){
          return {
            id: r._id,
            label: r.name,
            subtitle: [r.origin, r.destination].filter(Boolean).join(' → ')
          };
        });
      }
      function formatAcc(data) {
        return (data || []).map(function(a){
          var luxury = a.isLuxury ? ' (Luxury)' : '';
          return {
            id: a._id,
            label: a.accomodation_name + ' — ' + (a.place || 'TBD') + luxury,
            subtitle: a.place || ''
          };
        });
      }

      var ROUTES = formatRoutes(routesData);
      var ACCS = formatAcc(accData);
      function closeAllPopovers() {
        document.querySelectorAll('.search-popover').forEach(function(p){ p.classList.add('d-none'); });
      }

      function renderOptions(popover, items) {
        if (!popover) return;
        if (!items.length) {
          popover.innerHTML = '<div class="list-group-item text-muted small">No matches</div>';
          return;
        }
        popover.innerHTML = items.map(function(item){
          return '<button type="button" class="list-group-item list-group-item-action" data-id="' + item.id + '" data-label="' + item.label.replace(/"/g,'&quot;') + '">' +
            '<div class="fw-semibold">' + item.label + '</div>' +
            (item.subtitle ? '<small>' + item.subtitle + '</small>' : '') +
          '</button>';
        }).join('');
      }

      function attachSearch(row) {
        var inputs = row.querySelectorAll('.search-input');
        inputs.forEach(function(input){
          var kind = input.getAttribute('data-kind');
          var hidden = input.parentElement.querySelector(kind === 'route' ? 'input[name="routeId"]' : 'input[name="accomodationId"]');
          var popover = input.parentElement.querySelector('.search-popover');
          if (!hidden || !popover) return;

          var data = kind === 'route' ? ROUTES : ACCS;

          function filterItems(value) {
            var q = (value || '').toLowerCase();
            if (!q) return data.slice(0, 12);
            return data.filter(function(item){
              return item.label.toLowerCase().includes(q) || (item.subtitle && item.subtitle.toLowerCase().includes(q));
            }).slice(0, 12);
          }

          function open() {
            closeAllPopovers();
            renderOptions(popover, filterItems(input.value));
            popover.classList.remove('d-none');
          }
          function close() {
            popover.classList.add('d-none');
          }

          input.addEventListener('focus', open);
          input.addEventListener('click', open);
          input.addEventListener('input', function(){
            hidden.value = '';
            renderOptions(popover, filterItems(input.value));
            popover.classList.remove('d-none');
          });

          popover.addEventListener('click', function(e){
            var btn = e.target.closest('button[data-id]');
            if (!btn) return;
            var label = btn.getAttribute('data-label');
            var id = btn.getAttribute('data-id');
            input.value = label;
            hidden.value = id;
            close();
          });
        });
      }
      document.addEventListener('click', function(evt){
        if (!evt.target.closest('.search-popover') && !evt.target.closest('.search-input')) {
          closeAllPopovers();
        }
      });

      function addRow(){
        var count = list.querySelectorAll('.it-day-row').length + 1;
        var template = list.querySelector('.it-day-row');
        if (!template) return;
        var clone = template.cloneNode(true);
        clone.setAttribute('data-row', String(count));
        var dayInput = clone.querySelector('[name="day"]');
        if (dayInput) {
          dayInput.value = count;
          dayInput.id = 'day-' + count;
          var dayLabel = clone.querySelector('label[for^="day-"]');
          if (dayLabel) dayLabel.setAttribute('for', 'day-' + count);
        }
        var routeInput = clone.querySelector('[data-kind="route"]');
        if (routeInput) {
          routeInput.value = '';
          routeInput.id = 'route-search-' + count;
          var routeLabel = clone.querySelector('label[for^="route-search-"]');
          if (routeLabel) routeLabel.setAttribute('for', 'route-search-' + count);
        }
        var routeHidden = clone.querySelector('input[name="routeId"]');
        if (routeHidden) routeHidden.value = '';

        var accInput = clone.querySelector('[data-kind="accommodation"]');
        if (accInput) {
          accInput.value = '';
          accInput.id = 'accommodation-search-' + count;
          var accLabel = clone.querySelector('label[for^="accommodation-search-"]');
          if (accLabel) accLabel.setAttribute('for', 'accommodation-search-' + count);
        }
        var accHidden = clone.querySelector('input[name="accomodationId"]');
        if (accHidden) accHidden.value = '';

        var adultInput = clone.querySelector('[name="adult_price"]');
        if (adultInput) {
          adultInput.value = '0';
          adultInput.id = 'adult_price-' + count;
          var aLabel = clone.querySelector('label[for^="adult_price-"]');
          if (aLabel) aLabel.setAttribute('for', 'adult_price-' + count);
        }
        var childInput = clone.querySelector('[name="child_price"]');
        if (childInput) {
          childInput.value = '0';
          childInput.id = 'child_price-' + count;
          var cLabel = clone.querySelector('label[for^="child_price-"]');
          if (cLabel) cLabel.setAttribute('for', 'child_price-' + count);
        }
        list.appendChild(clone);
        attachSearch(clone);
      }

      addBtn && addBtn.addEventListener('click', addRow);
      list && list.addEventListener('click', function(e){
        var btn = e.target.closest('[data-remove-row]');
        if (!btn) return;
        var rows = list.querySelectorAll('.it-day-row');
        var row = btn.closest('.it-day-row');
        if (!row) return;
        if (rows.length > 1) {
          row.remove();
        } else {
          // Keep at least one row; clear inputs
          var dayInput = row.querySelector('[name="day"]');
          if (dayInput) dayInput.value = '1';
          var routeInput = row.querySelector('[data-kind="route"]');
          if (routeInput) routeInput.value = '';
          var routeHidden = row.querySelector('input[name="routeId"]');
          if (routeHidden) routeHidden.value = '';
          var accInput = row.querySelector('[data-kind="accommodation"]');
          if (accInput) accInput.value = '';
          var accHidden = row.querySelector('input[name="accomodationId"]');
          if (accHidden) accHidden.value = '';
          var adultInput = row.querySelector('[name="adult_price"]');
          if (adultInput) adultInput.value = '0';
          var childInput = row.querySelector('[name="child_price"]');
          if (childInput) childInput.value = '0';
        }
      });

      // Initialize search for first row
      attachSearch(list.querySelector('.it-day-row'));
    })();
  </script>
