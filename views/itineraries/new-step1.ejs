<section class="py-4">
  <h1 class="h5 mb-3">New Itinerary • Step 1</h1>
  <form id="it-new-form" action="/dashboard/itineraries/new/choose-acc" method="post" class="sb-form">
    <div class="row g-3 mb-3">
      <div class="col-md-4"><label class="form-label" for="title">Title</label><input id="title" name="title" class="form-control" placeholder="e.g., 7-Day Northern Circuit" required></div>
      <div class="col-md-3"><label class="form-label" for="startDate">Start Date</label><input id="startDate" name="startDate" type="date" class="form-control"></div>
      <div class="col-md-2"><label class="form-label" for="adults">Adults</label><input id="adults" name="adults" type="number" class="form-control" value="2" min="0"></div>
      <div class="col-md-2"><label class="form-label" for="children">Children</label><input id="children" name="children" type="number" class="form-control" value="0" min="0"></div>
    </div>

    <div class="card sb-card"><div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="h6 mb-0">Days</h2>
        <button id="add-day-btn" class="btn btn-sm btn-outline-primary" type="button"><i class="fa-solid fa-plus me-1"></i> Add Day</button>
      </div>
      <div id="days-list" class="d-flex flex-column gap-2">
        <div class="row g-2 align-items-end it-day-row" data-row="1">
          <div class="col-12 col-md-2">
            <label class="form-label" for="day-1">Day</label>
            <input id="day-1" name="day" type="number" class="form-control" value="1" min="1">
          </div>
          <div class="col-12 col-md-5">
            <label class="form-label" for="routeId-1">Route</label>
            <select id="routeId-1" name="routeId" class="form-select" required>
              <option value="">Select route</option>
              <% (routes || []).forEach(function(r){ %>
                <option value="<%= r._id %>"><%= r.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label" for="accomodationId-1">Accommodation</label>
            <select id="accomodationId-1" name="accomodationId" class="form-select">
              <option value="">Optional — choose accommodation</option>
              <% (accomodations || []).forEach(function(a){ %>
                <option value="<%= a._id %>"><%= a.accomodation_name %> (USD <%= Number(a.price || 0).toLocaleString('en-US') %>)</option>
              <% }) %>
            </select>
          </div>
          <div class="col-12 col-md-1 text-md-end">
            <button type="button" class="btn btn-outline-danger mt-2 mt-md-0" data-remove-row><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>
      </div>
    </div></div>

    <div class="row g-3 mt-3">
      <div class="col-md-6">
        <label class="form-label" for="inclusionsText">Price Inclusions (one per line)</label>
        <textarea id="inclusionsText" name="inclusionsText" class="form-control" rows="5" placeholder="Private 4x4 vehicle\nProfessional guide\nAll park fees"></textarea>
        <div class="form-text">Use a new line for each item. These appear on the final PDF.</div>
      </div>
      <div class="col-md-6">
        <label class="form-label" for="exclusionsText">Price Exclusions (one per line)</label>
        <textarea id="exclusionsText" name="exclusionsText" class="form-control" rows="5" placeholder="International flights\nVisa fees\nPersonal insurance"></textarea>
        <div class="form-text">Leave blank if you want to rely on the default language.</div>
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-3">
        <label class="form-label" for="profitPercent">Company Profit (%)</label>
        <input id="profitPercent" name="profitPercent" type="number" class="form-control" value="0" min="0" max="100" step="0.1">
        <div class="form-text">Internal only. Not shown on the client PDF.</div>
      </div>
    </div>

    <div class="d-flex justify-content-end mt-3"><button class="btn btn-primary" type="submit">Next</button></div>
  </form>
</section>

<script>
    (function(){
      var addBtn = document.getElementById('add-day-btn');
      var list = document.getElementById('days-list');
      function addRow(){
        var count = list.querySelectorAll('.it-day-row').length + 1;
        var template = list.querySelector('.it-day-row');
        if (!template) return;
        var clone = template.cloneNode(true);
        clone.setAttribute('data-row', String(count));
        var dayInput = clone.querySelector('[name="day"]');
        if (dayInput) {
          dayInput.value = count;
          dayInput.id = 'day-' + count;
          var dayLabel = clone.querySelector('label[for^="day-"]');
          if (dayLabel) dayLabel.setAttribute('for', 'day-' + count);
        }
        var routeSelect = clone.querySelector('[name="routeId"]');
        if (routeSelect) {
          routeSelect.value = '';
          routeSelect.id = 'routeId-' + count;
          var routeLabel = clone.querySelector('label[for^="routeId-"]');
          if (routeLabel) routeLabel.setAttribute('for', 'routeId-' + count);
        }
        var accSelect = clone.querySelector('[name="accomodationId"]');
        if (accSelect) {
          accSelect.value = '';
          accSelect.id = 'accomodationId-' + count;
          var accLabel = clone.querySelector('label[for^="accomodationId-"]');
          if (accLabel) accLabel.setAttribute('for', 'accomodationId-' + count);
        }
        list.appendChild(clone);
      }
      addBtn && addBtn.addEventListener('click', addRow);
      list && list.addEventListener('click', function(e){
        var btn = e.target.closest('[data-remove-row]');
        if (!btn) return;
        var rows = list.querySelectorAll('.it-day-row');
        var row = btn.closest('.it-day-row');
        if (!row) return;
        if (rows.length > 1) {
          row.remove();
        } else {
          // Keep at least one row; clear inputs
          var dayInput = row.querySelector('[name="day"]');
          if (dayInput) dayInput.value = '1';
          var routeSelect = row.querySelector('[name="routeId"]');
          if (routeSelect) routeSelect.value = '';
          var accSelect = row.querySelector('[name="accomodationId"]');
          if (accSelect) accSelect.value = '';
        }
      });
    })();
  </script>
